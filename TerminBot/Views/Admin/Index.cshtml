@model TerminBot.Controllers.AdminController.AdminVm
@using static DateTimeUtils
@using static BusinessRules
@{
    ViewData["Title"] = "Admin dashboard";
    var lang = "hr";
    var total  = (int)(ViewBag.Total ?? 0);
    var page   = (int)(ViewBag.Page ?? 1);
    var pageSize = (int)(ViewBag.PageSize ?? 20);
    var pages  = (int)Math.Ceiling((double)total / pageSize);
    var todayCount = (int)(ViewBag.TodayCount ?? 0);
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Admin dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-body-tertiary">
<div class="container py-4">

    <!-- HEADER / TOOLBAR -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <div class="d-flex align-items-center gap-3">
            <h3 class="m-0">Admin dashboard</h3>
            <span class="badge text-bg-primary">Ukupno: @total</span>
            <span class="badge text-bg-success">Danas: @todayCount</span>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/auth/logout">Logout</a>
        </div>
    </div>

    @if (TempData["Msg"] is string flash && !string.IsNullOrWhiteSpace(flash))
    {
        <div class="alert alert-success shadow-sm">@flash</div>
    }

    <!-- FILTERI + OTKAZI PO KODU -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-9">
            <form method="get" class="card card-body shadow-sm">
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <label class="form-label">Od (dd.MM.)</label>
                        <input name="from" class="form-control" value="@Model.From" placeholder="17.09." />
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Do (dd.MM.)</label>
                        <input name="to" class="form-control" value="@Model.To" placeholder="20.09." />
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">Usluga</label>
                        <input name="service" class="form-control" value="@Model.Service" placeholder="it / vodoinstalacija / klima..." />
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">Traži (ime / UserId / kod)</label>
                        <input name="q" class="form-control" value="@Model.Q" placeholder="Ivan, 663f…, AB12-CD34" />
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary">Primijeni filtre</button>
                    <a class="btn btn-outline-secondary" href="/admin">Reset</a>
                </div>
            </form>
        </div>

        <div class="col-12 col-lg-3">
            <div class="card card-body shadow-sm h-100">
                <h6 class="mb-2">Otkaži po kodu</h6>
                <form method="post" action="/admin/cancel-by-code" onsubmit="return confirm('Otkazati rezervaciju?');">
                    @Html.AntiForgeryToken()
                    <div class="input-group">
                        <input name="code" class="form-control" placeholder="AB12-CD34" />
                        <button class="btn btn-danger">Otkaži</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- TABLICA -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title m-0">Rezervacije</h5>
            </div>

            @if (!Model.Items.Any())
            {
                <div class="text-muted">Nema rezultata za odabrane filtre.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                        <tr>
                            <th>Kod</th>
                            <th>Datum</th>
                            <th>Vrijeme</th>
                            <th>Ime</th>
                            <th>Usluga</th>
                            <th>Kontakt</th>
                            <th>UserId</th>
                            <th class="text-end" style="width:160px;"></th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var r in Model.Items)
                        {
                            var svc = string.IsNullOrWhiteSpace(r.ServiceType) ? "-" : LocalizeService(r.ServiceType, lang);
                            <tr>
                                <td><code>@r.BookingCode</code></td>
                                <td>@(string.IsNullOrEmpty(r.DayIso) ? r.Day : PrettyDate(r.DayIso))</td>
                                <td>@(string.IsNullOrEmpty(r.TimeIso) ? r.Time : r.TimeIso)</td>
                                <td>@(string.IsNullOrWhiteSpace(r.UserName) ? "-" : r.UserName)</td>
                                <td>@svc</td>
                                <td>@(string.IsNullOrWhiteSpace(r.Contact) ? "-" : r.Contact)</td>
                                <td class="small"><code>@r.UserId</code></td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-2">
                                        <a class="btn btn-sm btn-outline-primary" href="/admin/edit/@r.Id">Edit</a>
                                        <form method="post" action="/admin/cancel/@r.Id" onsubmit="return confirm('Otkazati ovaj termin?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="returnUrl" value="@($"{Context.Request.Path}{Context.Request.QueryString}")" />
                                            <button class="btn btn-sm btn-outline-danger">Cancel</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                <!-- PAGINACIJA -->
                @if (pages > 1)
                {
                    <nav class="mt-3 d-flex flex-wrap gap-1">
                        @for (int i = 1; i <= pages; i++)
                        {
                                var url = Url.Action("Index", "Admin", new
                                {
                                    q = Model.Q,
                                    service = Model.Service,
                                    from = Model.From,
                                    to = Model.To,
                                    page = i,
                                    pageSize = pageSize
                                });
                                <a class="btn btn-sm @(i==page?"btn-primary":"btn-outline-secondary")" href="@url">@i</a>
                        }
                    </nav>
                }
            }
        </div>
    </div>

</div>
</body>
</html>
